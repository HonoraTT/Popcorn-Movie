<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.movietime.dao.UserOrderDao">

    <resultMap id="UserOrderResultMap" type="com.movietime.entity.UserOrder">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="movie_id" property="movieId" jdbcType="BIGINT"/>
        <result column="show_id" property="showId" jdbcType="BIGINT"/>
        <result column="movie_name" property="movieName" jdbcType="VARCHAR"/>
        <result column="movie_poster" property="moviePoster" jdbcType="VARCHAR"/>
        <result column="cinema_name" property="cinemaName" jdbcType="VARCHAR"/>
        <result column="show_time" property="showTime" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="order_time" property="orderTime" jdbcType="TIMESTAMP"/>
        <result column="total_price" property="totalPrice" jdbcType="DECIMAL"/>
        <result column="seats" property="seats" jdbcType="LONGVARCHAR"/>
    </resultMap>

    <!-- 根据用户ID获取用户订单列表 -->
    <select id="getUserOrders" resultMap="UserOrderResultMap">
        SELECT * FROM user_order 
        WHERE user_id = #{userId}
        ORDER BY order_time DESC
    </select>

    <!-- 根据用户ID获取最近的订单（限制数量） -->
    <select id="getRecentOrders" resultMap="UserOrderResultMap">
        SELECT * FROM user_order 
        WHERE user_id = #{userId}
        ORDER BY order_time DESC
        LIMIT #{limit}
    </select>

    <!-- 创建新订单 -->
    <insert id="createOrder" parameterType="com.movietime.entity.UserOrder" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_order (
            user_id, movie_id, show_id, movie_name, movie_poster, 
            cinema_name, show_time, status, order_time, total_price, seats
        ) VALUES (
            #{userId}, #{movieId}, #{showId}, #{movieName}, #{moviePoster},
            #{cinemaName}, #{showTime}, #{status}, #{orderTime}, #{totalPrice}, #{seats}
        )
    </insert>

    <!-- 更新订单状态 -->
    <update id="updateOrderStatus">
        UPDATE user_order 
        SET status = #{status}
        WHERE id = #{orderId}
    </update>

    <!-- 根据订单ID获取订单详情 -->
    <select id="getOrderById" resultMap="UserOrderResultMap">
        SELECT * FROM user_order 
        WHERE id = #{orderId}
    </select>

    <!-- 根据用户ID统计订单数量 -->
    <select id="countUserOrders" resultType="int">
        SELECT COUNT(*) FROM user_order 
        WHERE user_id = #{userId}
    </select>

    <!-- 删除订单 -->
    <delete id="deleteOrder">
        DELETE FROM user_order 
        WHERE id = #{orderId}
    </delete>

</mapper>
